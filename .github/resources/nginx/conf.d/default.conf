server {
    listen 80;
    server_name localhost;

    # 바디 크기 제한
    client_max_body_size 100m;

    # [중요] 도커 내부 DNS 주소 (이게 없으면 변수 사용 시 502 뜸)
    resolver 127.0.0.11 valid=5s;

    # [핵심] service-url.inc 파일을 포함하여 $service_url 변수를 가져옴
    # 이 파일 안에는 "set $service_url http://app-blue:8080;" 같은 내용이 들어있음
    include /etc/nginx/conf.d/service-url.inc;

    location / {
        # Docker DNS가 $service_url(예: app-blue)을 내부 IP로 변환하여 전달
        proxy_pass $service_url;

        # [헤더 설정] 실제 클라이언트의 정보를 Spring Boot에 전달하기 위함
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 1. 브라우저가 보낸 Origin(출처)을 백엔드에 그대로 전달
        #  (이게 없으면 Spring은 누가 요청했는지 몰라 CORS 헤더를 안 내려줍니다.)
        proxy_set_header Origin $http_origin;

        # 2. Preflight(OPTIONS) 요청 시 사용하는 헤더들도 전달
        proxy_set_header Access-Control-Request-Method $http_access_control_request_method;
        proxy_set_header Access-Control-Request-Headers $http_access_control_request_headers;
    }
}