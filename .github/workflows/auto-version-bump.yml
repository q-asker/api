name: Auto Bump Version on PR

on:
  pull_request:
    types: [ opened, edited ] # PR이 열리거나 제목이 수정될 때 동작
    branches:
      - main # main 브랜치를 대상으로 하는 PR만

permissions:
  contents: write # 리포지토리에 커밋을 푸시하기 위해 쓰기 권한 필수

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Branch
        uses: actions/checkout@v4
        with:
          # 중요: PR의 머지된 코드가 아니라, 소스 브랜치(develop) 자체를 체크아웃해야 푸시 가능
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Version from PR Title
        id: get_version
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR Title: $TITLE"
          
          # 정규식: v1.2.3 또는 release/v1.2.3 등에서 숫자.숫자.숫자 추출
          if [[ $TITLE =~ ([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            NEW_VERSION="${BASH_REMATCH[1]}"
            echo "New Version Detected: $NEW_VERSION"
            echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "No version pattern (vX.Y.Z) found in title. Skipping."
            echo "NEW_VERSION=" >> $GITHUB_ENV
          fi

      - name: Update build.gradle
        if: env.NEW_VERSION != ''
        run: |
          # build.gradle 파일에서 version = "..." 패턴을 찾아 새 버전으로 교체
          # 주의: 사용하시는 포맷(version = "1.4.0")에 맞춰 정규식 작성됨
          sed -i -E "s/version = \"[0-9]+\.[0-9]+\.[0-9]+\"/version = \"$NEW_VERSION\"/" build.gradle
          
          # 변경 내용 확인 (로그용)
          grep "version =" build.gradle

      - name: Commit and Push Changes
        if: env.NEW_VERSION != ''
        run: |
          # Git 사용자 설정 (봇 이름으로 설정)
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 변경 사항이 있을 때만 커밋
          if [[ -n $(git status -s) ]]; then
            git add build.gradle
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            git push origin HEAD:${{ github.head_ref }}
            echo "Successfully pushed version update."
          else
            echo "No changes to commit."
          fi