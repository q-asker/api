name: Docker Hub Push & 배포 서버 EC2 배포
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: 빌드 작업
    runs-on: ubuntu-latest
    env:
      APPLICATION_PROD_YML: ${{ secrets.APPLICATION_PROD_YML }}
      NEWRELIC_YML: ${{ secrets.NEWRELIC_YML }}
      GRADLE_PROPERTIES: ${{ secrets.GRADLE_PROPERTIES }}

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: 환경변수들 등록
        run: |
          echo "${{ env.NEWRELIC_YML }}" > app/newrelic/newrelic.yml
          echo "${{ env.APPLICATION_PROD_YML }}" > app/src/main/resources/application-prod.yml
          echo "${{ env.GRADLE_PROPERTIES }}" > app/gradle.properties

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Gradle 설정
        uses: gradle/actions/setup-gradle@v4

      - name: Jib로 Docker 이미지 빌드 및 푸시
        run: ./gradlew jib -PPROFILE=prod --build-cache

  deploy:
    name: EC2 배포
    needs: build
    runs-on: ubuntu-latest
    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}
      EC2_KEY: ${{ secrets.EC2_KEY }}
      BLUE_PORT: 8001
      GREEN_PORT: 8002
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: gradle.properties 값 환경 변수로 등록 및 마스킹
        run: |
          # DOCKER_ID 추출, 마스킹, 환경 변수 등록
          DOCKER_ID_VALUE=$(echo "${{ secrets.GRADLE_PROPERTIES }}" | grep '^DOCKER_ID=' | cut -d'=' -f2-)
          echo "DOCKER_ID=$DOCKER_ID_VALUE" >> $GITHUB_ENV
          
          # DOCKER_IMAGE_NAME 추출, 마스킹, 환경 변수 등록
          DOCKER_IMAGE_NAME_VALUE=$(echo "${{ secrets.GRADLE_PROPERTIES }}" | grep '^DOCKER_IMAGE_NAME=' | cut -d'=' -f2-)
          echo "DOCKER_IMAGE_NAME=$DOCKER_IMAGE_NAME_VALUE" >> $GITHUB_ENV
          
          # DOCKER_PASSWORD 추출, 마스킹, 환경 변수 등록
          DOCKER_PASSWORD_VALUE=$(echo "${{ secrets.GRADLE_PROPERTIES }}" | grep '^DOCKER_PASSWORD=' | cut -d'=' -f2-)
          echo "::add-mask::$DOCKER_PASSWORD_VALUE"
          echo "DOCKER_PASSWORD=$DOCKER_PASSWORD_VALUE" >> $GITHUB_ENV
          
          # DOCKER_CONTAINER_NAME 생성, 등록
          DOCKER_CONTAINER_NAME_VALUE="${DOCKER_ID_VALUE}-${DOCKER_IMAGE_NAME_VALUE}"
          echo "DOCKER_CONTAINER_NAME=$DOCKER_CONTAINER_NAME_VALUE" >> $GITHUB_ENV

      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: build.gradle 버전 추출
        run: |
          # version = "1.2.3" 또는 '1.2.3' 패턴에서 숫자 부분만 추출
          VERSION=$(sed -nE "s/.*version = ['\"]([^'\"]+)['\"].*/\1/p" build.gradle)

          if [ -z "$VERSION" ]; then
            echo "::error::build.gradle에서 버전을 찾을 수 없습니다."
            exit 1
          fi

          echo "Extracted Version: $VERSION"
          
          # 도커 이미지 변수 참조 가능하게 함
          echo "DOCKER_IMAGE_NAME=${{ env.DOCKER_ID }}/${{ env.DOCKER_IMAGE_NAME }}:$VERSION" >> $GITHUB_ENV

      - name: 배포 파일(Docker Compose, Script, Nginx) 전송
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.EC2_KEY }}
          source: ".github/resources/*"
          target: "/home/${{ env.EC2_USER }}/deploy"
          strip_components: 2

      - name: EC2에 배포
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ env.EC2_KEY }}
          debug: true
          script: |
            # 1. 배포 폴더로 이동 (SCP로 전송된 위치)
            cd /home/${{ env.EC2_USER }}/deploy
            
            # 2. .env 파일 생성 (docker-compose.yml에서 사용)
            echo "DOCKER_IMAGE=${{ env.DOCKER_IMAGE_NAME }}" > .env
            echo "BLUE_PORT=${{ env.BLUE_PORT }}" >> .env
            echo "GREEN_PORT=${{ env.GREEN_PORT }}" >> .env
            
            # 3. Docker 로그인
            echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_ID }}" --password-stdin
            
            # 4. deploy.sh 실행 (기존의 docker run 대신 사용)
            chmod +x deploy.sh
            export SLACK_WEBHOOK_URL="${{ env.SLACK_WEBHOOK_URL }}"
            ./deploy.sh "${{ env.BLUE_PORT }}" "${{ env.GREEN_PORT }}" "${{ env.DOCKER_IMAGE_NAME }}"