plugins {
    id 'org.springframework.boot'
    id "com.google.cloud.tools.jib" version "3.4.0"
    id "de.undercouch.download" version "5.3.0"
}

version = rootProject.version
group = rootProject.group


dependencies {

    implementation project(':auth:auth-impl')
    implementation project(':aws:aws-impl')
    implementation project(':quiz:quiz-impl')

    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
}

springBoot {
    buildInfo()
}

jib {
    from {
        image = "amazoncorretto:21"
    }
    to {
        image = "${project.property("DOCKER_ID")}/${project.property("DOCKER_IMAGE_NAME")}"
        tags = ["latest", rootProject.version.toString()]
        auth {
            username = project.property("DOCKER_ID")
            password = project.property("DOCKER_PASSWORD")
        }
    }
    extraDirectories {
        paths {
            path {
                setFrom(file("./app/scouter").toPath())
                into = "/app/scouter"
            }
        }
    }
    container {
        def jvmHeapSize = project.property("JVM_HEAP_SIZE")

        // ê¸°ë³¸ JVM í”Œë˜ê·¸ ì„¤ì •
        jvmFlags = ["-Xms${jvmHeapSize}", "-Xmx${jvmHeapSize}"]

        def scouterJar = project.file("/app/scouter/agent.java/scouter.agent.jar")

        if (scouterJar.exists()) {
            // 1. í•„ìˆ˜ê°’ ê²€ì¦ (ê°’ì´ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë¹Œë“œ ì‹¤íŒ¨í•¨ ğŸ›‘)
            if (!project.hasProperty("SCOUTER_IP")) {
                throw new GradleException("âŒ [ë¹Œë“œ ì‹¤íŒ¨] SCOUTER_IP í”„ë¡œí¼í‹°ê°€ ì—†ìŠµë‹ˆë‹¤. (-PSCOUTER_IP=... ì˜µì…˜ í•„ìš”)")
            }
            if (!project.hasProperty("SCOUTER_PORT")) {
                throw new GradleException("âŒ [ë¹Œë“œ ì‹¤íŒ¨] SCOUTER_PORT í”„ë¡œí¼í‹°ê°€ ì—†ìŠµë‹ˆë‹¤. (-PSCOUTER_PORT=... ì˜µì…˜ í•„ìš”)")
            }
            if (!project.hasProperty("SCOUTER_OBJ_NAME")) {
                throw new GradleException("âŒ [ë¹Œë“œ ì‹¤íŒ¨] SCOUTER_OBJ_NAME í”„ë¡œí¼í‹°ê°€ ì—†ìŠµë‹ˆë‹¤. (-PSCOUTER_OBJ_NAME=... ì˜µì…˜ í•„ìš”)")
            }

            // 2. ê°’ í• ë‹¹ (ê²€ì¦ í†µê³¼í–ˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´)
            def collectorIp = project.property("SCOUTER_IP")
            def objName = project.property("SCOUTER_OBJ_NAME")
            def collectorPort = project.property("SCOUTER_PORT")

            jvmFlags = jvmFlags + [
                    // [í•„ìˆ˜] ì—ì´ì „íŠ¸ ë¡œë“œ
                    "-javaagent:/app/scouter/agent.java/scouter.agent.jar",

                    // [í•„ìˆ˜] conf íŒŒì¼ ëŒ€ì‹  ì§ì ‘ ì„¤ì • ì£¼ì…
                    "-Dnet_collector_ip=${collectorIp}",
                    "-Dnet_collector_udp_port=${collectorPort}",
                    "-Dnet_collector_tcp_port=${collectorPort}",

                    // [ë³´ì•ˆ ì„¤ì •: ê¶Œì¥] í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì œì–´ ê¸°ëŠ¥(HeapDump, Method Patch ë“±) ë¹„í™œì„±í™”
                    "-Denable_mgr_agent=false",

                    // [ê¶Œì¥] ì–´í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
                    "-Dobj_name=${objName}"

            ]
        }
    }
}