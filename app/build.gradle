plugins {
    id 'org.springframework.boot'
    id "com.google.cloud.tools.jib" version "3.4.0"
    id "de.undercouch.download" version "5.3.0"
}

version = rootProject.version
group = rootProject.group


dependencies {

    implementation project(':auth:auth-impl')
    implementation project(':aws:aws-impl')
    implementation project(':quiz:quiz-impl')

    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
}

springBoot {
    buildInfo()
}

jib {
    from {
        image = "amazoncorretto:21"
    }
    to {
        image = "${project.property("DOCKER_ID")}/${project.property("DOCKER_IMAGE_NAME")}"
        tags = ["latest", rootProject.version.toString()]
        auth {
            username = project.property("DOCKER_ID")
            password = project.property("DOCKER_PASSWORD")
        }
    }
    extraDirectories {
        paths {
            path {
                setFrom(file("./scouter").toPath())
                into = "/app/scouter"
            }
        }
    }
    container {
        def jvmHeapSize = project.property("JVM_HEAP_SIZE")

        // ê¸°ë³¸ JVM í”Œë˜ê·¸ ì„¤ì •
        jvmFlags = ["-Xms${jvmHeapSize}", "-Xmx${jvmHeapSize}"]

        def scouterJar = project.file("./scouter/agent.java/scouter.agent.jar")

        if (!scouterJar.exists()) {
            throw new GradleException("Scouter agent file not found: ${scouterJar.absolutePath}")
        }

        // 1. í•„ìˆ˜ê°’ ê²€ì¦ (ê°’ì´ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë¹Œë“œ ì‹¤íŒ¨í•¨ ğŸ›‘)
        def requiredProps = ["SCOUTER_IP", "SCOUTER_PORT", "SCOUTER_OBJ_NAME"]
        requiredProps.each { prop ->
            if (!project.hasProperty(prop)) {
                throw new GradleException("âŒ [ë¹Œë“œ ì‹¤íŒ¨] ${prop} í”„ë¡œí¼í‹°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. (-P${prop}=ê°’ í•„ìš”)")
            }
        }

        // 2. ê°’ í• ë‹¹ (ê²€ì¦ í†µê³¼í–ˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜´)
        def collectorIp = project.property("SCOUTER_IP")
        def objName = project.property("SCOUTER_OBJ_NAME")
        def collectorPort = project.property("SCOUTER_PORT")

        jvmFlags = jvmFlags + [
                // [í•„ìˆ˜] ì—ì´ì „íŠ¸ ë¡œë“œ
                "-javaagent:/app/scouter/agent.java/scouter.agent.jar",

                // [í•„ìˆ˜] Java 16+ ëŒ€ì‘ì„ ìœ„í•œ ëª¨ë“ˆ ì ‘ê·¼ í—ˆìš© ì˜µì…˜
                "--add-opens=java.base/java.lang=ALL-UNNAMED",
                "--add-opens=java.base/java.util=ALL-UNNAMED",

                // [í•„ìˆ˜] conf íŒŒì¼ ëŒ€ì‹  ì§ì ‘ ì„¤ì • ì£¼ì…
                "-Dnet_collector_ip=${collectorIp}",
                "-Dnet_collector_udp_port=${collectorPort}",
                "-Dnet_collector_tcp_port=${collectorPort}",

                // [ë³´ì•ˆ ì„¤ì •: ê¶Œì¥] í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì œì–´ ê¸°ëŠ¥(HeapDump, Method Patch ë“±) ë¹„í™œì„±í™”
                "-Denable_mgr_agent=false",

                // [ê¶Œì¥] ì–´í”Œë¦¬ì¼€ì´ì…˜ ì´ë¦„
                "-Dobj_name=${objName}"

        ]
    }
}