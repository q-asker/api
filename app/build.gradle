plugins {
    // Spring Boot 플러그인: 실행 가능 JAR(BootJar) 생성, 의존성 관리 등 부트 애플리케이션 빌드 지원
    // 예: ./gradlew :app:bootJar → BOOT-INF/lib에 모든 의존성을 포함한 fat JAR 생성,
    //     ./gradlew :app:bootRun → 애플리케이션을 로컬에서 바로 실행
    id 'org.springframework.boot'
    // Jib: Docker 데몬 없이 컨테이너 이미지를 빌드·푸시하는 Google 제공 플러그인
    // 예: ./gradlew jib → Dockerfile 없이 Docker Hub에 이미지를 빌드·푸시,
    //     ./gradlew jibDockerBuild → 로컬 Docker 데몬에 이미지를 빌드
    id "com.google.cloud.tools.jib" version "3.4.0"
    // Download: 외부 파일을 Gradle 태스크로 다운로드하는 플러그인
    // 예: download.run { src 'https://...' dest 'scouter.jar' }로 Scouter 에이전트 자동 다운로드
    id "de.undercouch.download" version "5.3.0"
}

// 루트 프로젝트의 version·group을 상속받아 일관된 아티팩트 좌표 유지
// 예: rootProject.version이 "1.7.0"이면 app 모듈도 동일하게 "1.7.0",
//     Docker 태그, JAR 파일명 등이 모두 이 버전을 사용
version = rootProject.version
group = rootProject.group


dependencies {

    // ────────────────────────────────
    // 프로젝트 모듈
    // 모든 impl 모듈을 조립하여 하나의 실행 가능 애플리케이션으로 구성
    // 예: Spring Boot가 기동될 때 각 모듈의 @Component, @Service, @Repository를W
    //     컴포넌트 스캔으로 자동 발견하여 Bean으로 등록
    // ────────────────────────────────
    // 인증 구현 모듈: JWT 발급·검증, OAuth2 소셜 로그인 처리
    // 예: AuthServiceImpl, JwtTokenProvider 등이 이 모듈에 위치
    implementation project(':auth:auth-impl')
    // AWS 구현 모듈: S3 파일 업로드·다운로드 처리
    // 예: S3ServiceImpl, PresignedUrlGenerator 등이 이 모듈에 위치
    implementation project(':aws:aws-impl')
    // 퀴즈 구현 모듈: 퀴즈 CRUD, 출제·채점 로직
    // 예: QuizServiceImpl, QuizRepository 등이 이 모듈에 위치
    implementation project(':quiz:quiz-impl')
    // 유틸리티 구현 모듈: 범용 헬퍼 기능
    // 예: HealthCheckController 등이 이 모듈에 위치
    implementation project(':util:util-impl')
    // 공통 모듈: 전역 예외 처리, 공통 응답 DTO
    // 예: GlobalExceptionHandler, ApiResponse<T>, BaseEntity 등이 이 모듈에 위치
    implementation project(':global')
    // AI 모듈: Google Gemini 기반 AI 기능
    // 예: AiService에서 ChatClient를 통해 Gemini API를 호출
//    implementation project(':ai')

    // ────────────────────────────────
    // 스프링부트 Web & JPA
    // ────────────────────────────────
    // Spring MVC 기반 웹 애플리케이션 구성
    // 예: 내장 Tomcat이 기동되고, DispatcherServlet이 모든 HTTP 요청을 라우팅
    implementation "org.springframework.boot:spring-boot-starter-web"
    // Spring Data JPA: JPA 기반 리포지토리 자동 생성, 엔티티 매핑 지원
    // 예: spring.jpa.hibernate.ddl-auto=validate 설정으로 엔티티와 DB 스키마 일치 여부를 검증
    implementation "org.springframework.boot:spring-boot-starter-data-jpa"
    // Configuration Processor: @ConfigurationProperties 클래스의 메타데이터를 자동 생성
    // 예: @ConfigurationProperties(prefix = "app.jwt")로 선언하면
    //     IDE에서 application.yml의 app.jwt.* 속성을 자동완성·타입 검증 가능
    annotationProcessor 'org.springframework.boot:spring-boot-configuration-processor'
}

springBoot {
    // buildInfo(): META-INF/build-info.properties 파일을 생성
    // 예: 빌드 후 파일에 build.version=1.7.0, build.time=2024-01-01T00:00:00Z 등이 기록되고,
    //     Actuator /info 엔드포인트에서 {"build":{"version":"1.7.0",...}} 형태로 노출됨
    buildInfo()
}

jib {
    from {
        // 베이스 이미지: Amazon Corretto JDK 21 (AWS 최적화 OpenJDK 배포판)
        // 예: 최종 컨테이너는 amazoncorretto:21 위에 앱 JAR + 의존성이 레이어로 추가됨
        //     Alpine 기반보다 용량은 크지만 glibc 호환성과 AWS 환경 최적화 이점
        image = "amazoncorretto:21"
    }
    to {
        // 푸시할 Docker 이미지 이름: {DOCKER_ID}/{DOCKER_IMAGE_NAME}
        // 예: DOCKER_ID=myuser, DOCKER_IMAGE_NAME=qasker → myuser/qasker
        image = "${project.property("DOCKER_ID")}/${project.property("DOCKER_IMAGE_NAME")}"
        // latest 태그 + 프로젝트 버전 태그를 동시에 푸시
        // 예: ["latest", "1.7.0"] → myuser/qasker:latest, myuser/qasker:1.7.0 두 태그 생성
        tags = ["latest", rootProject.version.toString()]
        auth {
            // Docker Hub 인증 정보 (gradle.properties 또는 -P 옵션으로 전달)
            // 예: -PDOCKER_ID=myuser -PDOCKER_PASSWORD=secret 으로 빌드 시 전달
            username = project.property("DOCKER_ID")
            password = project.property("DOCKER_PASSWORD")
        }
    }
    extraDirectories {
        paths {
            path {
                // 로컬 ./scouter 디렉토리를 컨테이너의 /app/scouter 경로에 복사
                // 예: app/scouter/agent.java/scouter.agent.jar → 컨테이너 /app/scouter/agent.java/scouter.agent.jar
                setFrom(file("./scouter").toPath())
                into = "/app/scouter"
            }
        }
    }
    container {
        // JVM 힙 메모리 크기 설정 (-Xms: 초기 힙, -Xmx: 최대 힙)
        // 예: JVM_HEAP_SIZE=512m → -Xms512m -Xmx512m, 초기 힙과 최대 힙을 동일하게 설정하여
        //     GC로 인한 힙 리사이징 오버헤드를 방지
        def jvmHeapSize = project.property("JVM_HEAP_SIZE")
        jvmFlags = ["-Xms${jvmHeapSize}", "-Xmx${jvmHeapSize}"]

        // Scouter APM 에이전트 JAR 존재 여부 검증
        // 예: app/scouter/agent.java/scouter.agent.jar 파일이 없으면 빌드가 즉시 실패하여
        //     에이전트 누락된 채로 배포되는 상황을 방지
        def scouterJar = project.file("./scouter/agent.java/scouter.agent.jar")
        if (!scouterJar.exists()) {
            throw new GradleException("Scouter agent file not found: ${scouterJar.absolutePath}")
        }

        // Scouter 연동에 필요한 필수 프로퍼티 검증
        // 예: ./gradlew jib -PSCOUTER_IP=10.0.0.1 -PSCOUTER_PORT=6100 -PSCOUTER_OBJ_NAME=qasker-api
        //     하나라도 누락하면 빌드 실패 → 모니터링 설정 없이 배포되는 실수 방지
        def requiredProps = ["SCOUTER_IP", "SCOUTER_PORT", "SCOUTER_OBJ_NAME"]
        requiredProps.each { prop ->
            if (!project.hasProperty(prop)) {
                throw new GradleException("[빌드 실패] ${prop} 프로퍼티가 누락되었습니다. (-P${prop}=값 필요)")
            }
        }

        // Scouter APM 서버 연결 설정값 할당
        def collectorIp = project.property("SCOUTER_IP")
        def objName = project.property("SCOUTER_OBJ_NAME")
        def collectorPort = project.property("SCOUTER_PORT")

        jvmFlags = jvmFlags + [
                // Scouter Java 에이전트를 JVM에 어태치하여 성능 모니터링 활성화
                // 예: -javaagent로 로드되면 바이트코드 인스트루멘테이션으로 메서드 실행 시간,
                //     SQL 쿼리, HTTP 요청 등을 자동 수집
                "-javaagent:/app/scouter/agent.java/scouter.agent.jar",

                // Java 16+ 모듈 시스템에서 Scouter가 내부 API에 접근할 수 있도록 허용
                // 예: Scouter가 java.lang.Thread, java.util.HashMap 등의 내부 필드에 리플렉션으로
                //     접근하여 스레드 상태·객체 수를 모니터링 (이 옵션 없으면 InaccessibleObjectException 발생)
                "--add-opens=java.base/java.lang=ALL-UNNAMED",
                "--add-opens=java.base/java.util=ALL-UNNAMED",

                // Scouter Collector 서버 IP·포트 설정
                // 예: SCOUTER_IP=10.0.0.1, SCOUTER_PORT=6100이면
                //     UDP 6100으로 성능 데이터 전송, TCP 6100으로 제어 명령 수신
                "-Dnet_collector_ip=${collectorIp}",
                "-Dnet_collector_udp_port=${collectorPort}",
                "-Dnet_collector_tcp_port=${collectorPort}",

                // 보안: 원격 클라이언트에서 HeapDump, Method Patch 등 제어 기능 비활성화
                // 예: Scouter Client UI에서 "Heap Dump" 버튼 클릭 시 실행되지 않음
                //     운영 환경에서 의도치 않은 힙 덤프로 인한 서비스 지연 방지
                "-Denable_mgr_agent=false",

                // Scouter UI에 표시될 애플리케이션 식별 이름
                // 예: SCOUTER_OBJ_NAME=qasker-api → Scouter Client 화면에서 "qasker-api"로 표시
                "-Dobj_name=${objName}"
        ]
    }
}
